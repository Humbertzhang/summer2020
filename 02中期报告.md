## 项目信息



#### 项目名称

Python Agent 支持 Flask 或 Django 埋点



#### 方案描述

阅读skywalking-python项目关于插件相关的代码，了解插件具体工作机制。

之后阅读Django项目源码，结合历史版本相关API的变动，找到合适的函数作为插件注入点，并实现Trace记录，url中param记录等相关功能。



#### 时间规划

申请时原时间规划如下：

自7月1日到9月30日共有14周，其中第1周和第14周均不为整周。按照周数进行时间安排如下。

| 时间(2020年) | 计划                                                         |
| ------------ | ------------------------------------------------------------ |
| 第1-2周      | 阅读Flask中相关部分源码；阅读SkyWalking相关源码；进行相关调研，确认项目开发方案 |
| 第3-5周      | 进行Flask插件开发                                            |
| 第6-7周      | 进行Flask插件的代码测试，编写测试样例。                      |
| 第8-9周      | 提交Flask插件代码，尝试合并到主分支，并在此过程中根据code review意见对代码进行改进。 |
| 第10周       | 阅读Django中相关部分源码，拿出Django项目开发方案。           |
| 第11-13周    | 进行Django插件的开发；进行Django插件的代码测试，编写测试样例。 |
| 第14周       | 提交Django插件代码，尝试合并到主分支，并在此过程中根据code review意见对代码进行改进。 |





## 项目进度



#### 已完成工作：
因社区中有成员在项目正式开始前贡献了Flask的插件，因此我是从Django插件的编写开始的。

Django插件方面主要完成的工作有：

* Django插件代码
* Django插件测试代码
* 在主仓库skywalking中增加了Django作为PythonAgent支持自动收集的组件。并增加了Django Logo到主仓库中。
* 在插件提交并合并后，有用户反映Django插件不支持Django 2.2 之前的版本，我对此进行了修复。



在完成了Django插件的编写后，我又对PyMongo编写了相关插件。主要完成的工作有：

* PyMongo插件代码
* PyMongo插件测试代码
* 在主仓库skywalking中支持MongoDB的语言中增加Python.



#### 遇到的问题及解决方案：

遇到的问题主要包括代码测试问题，插件版本适配问题等。

* 代码测试问题：

在刚接触项目时，对项目测试的流程以及规则不熟悉，导致在初期编写完部分代码后不能进行合适的测试。后与导师交流后加深了对项目测试流程的了解，解决了测试的问题。

* 插件版本适配问题：

在编写Django以及PyMongo的插件的过程中，因为这些库的底层相关实现有时会随着版本的迭代而进行修改，导致插件不能适配所有的版本，因此在插件编写的过程中需要考虑插件的兼容性。此外还应当对库的版本进行检查，在库的版本不符合插件要求时，不加载插件。

导师提出可以在插件加载时增加一个版本检查机制，对插件对应的库进行相应检查。目前已经在着手编写相应代码。



#### 后续工作安排：

后续的工作中，我首先会将插件机制先建立起来，并选择合适的方式对其进行相应的测试。

之后会寻找其他可以进行优化或添加新功能的点，并继续进行贡献。